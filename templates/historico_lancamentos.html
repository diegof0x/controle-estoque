{% extends "layout_base.html" %}

{% block title %}Histórico de Lançamentos{% endblock %}

{% block head_extra %}
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Histórico de Lançamentos</h1>
    <a href="{{ url_for('exportar_historico_csv', **request.args) }}" class="btn btn-secondary">
        <i class="bi bi-download"></i> Exportar CSV
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">Filtros</div>
    <div class="card-body">
        <form action="{{ url_for('pagina_relatorio_historico') }}" method="get">
            <div class="row g-3">
                <div class="col-md-3"><label class="form-label">Data Início</label><input type="date" class="form-control" name="data_inicio" value="{{ filtros.data_inicio or '' }}"></div>
                <div class="col-md-3"><label class="form-label">Data Fim</label><input type="date" class="form-control" name="data_fim" value="{{ filtros.data_fim or '' }}"></div>
                <div class="col-md-2"><label class="form-label">Tipo</label><select class="form-select" name="tipo"><option value="">Todos</option><option value="entrada" {% if filtros.tipo == 'entrada' %}selected{% endif %}>Entrada</option><option value="saida" {% if filtros.tipo == 'saida' %}selected{% endif %}>Saída</option></select></div>
                <div class="col-md-2"><label class="form-label">Nº NF/Doc (Entrada)</label><input type="text" class="form-control" name="nf_doc" value="{{ filtros.nf_doc or '' }}"></div>
                <div class="col-md-2"><label class="form-label">Nº Req. Manual (Saída)</label><input type="text" class="form-control" name="req_manual" value="{{ filtros.req_manual or '' }}"></div>
                
                <div class="col-md-12"><label class="form-label">Produtos</label><select id="produtos_ids" name="produtos_ids" multiple>{% for p in todos_produtos %}<option value="{{ p.id }}" {% if p.id in filtros.produtos_ids %}selected{% endif %}>{{ p.descricao }}</option>{% endfor %}</select></div>
                <div class="col-md-4"><label class="form-label">Fornecedores</label><select id="fornecedores_ids" name="fornecedores_ids" multiple>{% for f in todos_fornecedores %}<option value="{{ f.id }}" {% if f.id in filtros.fornecedores_ids %}selected{% endif %}>{{ f.nome_fornecedor }}</option>{% endfor %}</select></div>
                <div class="col-md-4"><label class="form-label">Equipamentos</label><select id="equipamentos_ids" name="equipamentos_ids" multiple>{% for e in todos_equipamentos %}<option value="{{ e.id }}" {% if e.id in filtros.equipamentos_ids %}selected{% endif %}>{{ e.codigo_identificador }} - {{ e.descricao }}</option>{% endfor %}</select></div>
                <div class="col-md-4"><label class="form-label">Usuários</label><select id="usuarios_ids" name="usuarios_ids" multiple>{% for u in todos_usuarios %}<option value="{{ u.id }}" {% if u.id in filtros.usuarios_ids %}selected{% endif %}>{{ u.nome }}</option>{% endfor %}</select></div>

                <div class="col-12 text-center mt-3"><button type="submit" class="btn btn-primary">Aplicar Filtros</button><a href="{{ url_for('pagina_relatorio_historico') }}" class="btn btn-outline-secondary">Limpar</a></div>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Produto</th>
                <th class="text-center">Qtd</th>
                <th>Custo Unit.</th>
                <th>Valor Total</th>
                <th>Fornecedor / Requisitante</th>
                <th>Equipamento</th>
                <th>NF/Doc (Entrada)</th>
                <th>Req. Manual (Saída)</th>
                <th>Usuário</th>
            </tr>
        </thead>
        <tbody>
            {% for mov in movimentacoes %}
            <tr>
                <td>{{ mov.created_at | format_datetime }}</td>
                <td>{% if mov.tipo == 'entrada' %}<span class="badge bg-success">Entrada</span>{% else %}<span class="badge bg-warning text-dark">{{ mov.tipo|title }}</span>{% endif %}</td>
                <td><small>{{ mov.produtos.descricao if mov.produtos else 'N/A' }}</small></td>
                <td class="text-center">{{ mov.quantidade }}</td>
                <td>R$ {{ "%.2f"|format(mov.preco_unitario|float) }}</td>
                <td>R$ {{ "%.2f"|format((mov.preco_unitario|float) * (mov.quantidade|float)) }}</td>
                <td>
                    {% if mov.tipo == 'entrada' and mov.fornecedores %}{{ mov.fornecedores.nome_fornecedor }}
                    {% elif mov.colaboradores %}{{ mov.colaboradores.nome }}{% else %}N/A{% endif %}
                </td>
                <td><small>{{ mov.equipamentos.codigo_identificador if mov.equipamentos else '' }}</small></td>
                <td>{{ mov.numero_documento }}</td>
                <td>{{ mov.numero_requisicao_manual }}</td>
                <td><small>{{ mov.usuarios.nome if mov.usuarios else 'N/A' }}</small></td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center">Nenhum lançamento encontrado para os filtros selecionados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        new TomSelect('#produtos_ids',{plugins: ['remove_button'], placeholder: 'Todos'});
        new TomSelect('#fornecedores_ids',{plugins: ['remove_button'], placeholder: 'Todos'});
        new TomSelect('#usuarios_ids',{plugins: ['remove_button'], placeholder: 'Todos'});
        new TomSelect('#equipamentos_ids',{plugins: ['remove_button'], placeholder: 'Todos'});
    });
</script>
{% endblock %}