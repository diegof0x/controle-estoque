{% extends "layout_base.html" %}

{% block title %}Gerenciar Estoque - Controle Total{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gerenciamento de Estoque</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarProduto">
        <i class="bi bi-plus-circle-fill me-2"></i>Adicionar Novo Produto
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Código Interno</th>
                <th>Descrição</th>
                <th>Estoque Atual</th>
                <th>Custo Médio (R$)</th>
                <th>Categoria</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for produto in produtos %}
            <tr class="{% if produto.estoque_atual <= produto.estoque_minimo and produto.estoque_minimo > 0 %}table-danger{% endif %}">
                <td>{{ produto.id }}</td>
                <td>{{ produto.codigo_interno }}</td>
                <td>{{ produto.descricao }}</td>
                <td>{{ produto.estoque_atual }}</td>
                <td>{{ "R$ {:,.2f}".format(produto.valor_total_estoque / produto.quantidade_com_custo if produto.quantidade_com_custo > 0 else 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                <td>
                    {% if produto.categorias %}
                        {{ produto.categorias.nome_categoria }}
                    {% else %}
                        <span class="text-muted">Sem Categoria</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('pagina_movimentacao', produto_id=produto.id, tipo='entrada') }}" class="btn btn-success btn-sm" title="Registrar Entrada"><i class="bi bi-plus-circle"></i></a>
                    <a href="{{ url_for('pagina_movimentacao', produto_id=produto.id, tipo='saida') }}" class="btn btn-warning btn-sm" title="Registrar Saída"><i class="bi bi-dash-circle"></i></a>
                    {% if session.user_role == 'gestor' %}
                    <a href="{{ url_for('pagina_editar_produto', produto_id=produto.id) }}" class="btn btn-secondary btn-sm" title="Editar Produto"><i class="bi bi-pencil-square"></i></a>
                    <a href="{{ url_for('excluir_produto', produto_id=produto.id) }}" 
                       onclick="return confirm('Tem certeza que deseja excluir este produto? A ação não pode ser desfeita.');" 
                       class="btn btn-danger btn-sm" title="Excluir Produto"><i class="bi bi-trash-fill"></i></a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalAdicionarProduto" tabindex="-1" aria-labelledby="modalAdicionarProdutoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAdicionarProdutoLabel">Cadastrar Novo Produto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('adicionar_produto') }}" method="post" id="formAdicionarProduto">
            <div class="mb-3">
                <label for="codigo_interno" class="form-label">Código Interno:</label>
                <input type="text" class="form-control" id="codigo_interno" name="codigo_interno" required>
            </div>
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição:</label>
                <input type="text" class="form-control" id="descricao" name="descricao" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="unidade_medida" class="form-label">Unidade de Medida (PC, KG, LT...):</label>
                    <input type="text" class="form-control" id="unidade_medida" name="unidade_medida" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="estoque_minimo" class="form-label">Estoque Mínimo:</label>
                    <input type="number" class="form-control" id="estoque_minimo" name="estoque_minimo" value="0" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="categoria_id" class="form-label">Categoria:</label>
                <select class="form-select" id="categoria_id" name="categoria_id" required>
                    <option value="" disabled selected>Selecione uma categoria</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nome_categoria }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="submit" class="btn btn-primary" form="formAdicionarProduto">Salvar Produto</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}