{% extends "layout_base.html" %}

{% block title %}Relatório de Valoração de Estoque{% endblock %}

{% block head_extra %}
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <div>
        <strong>ATENÇÃO:</strong> Valoração da Interface em DESENVOLVIMENTO devido a Entrada Inicial sem Custeio.
    </div>
</div>
<div class="page-header">
    <h1>Relatório de Valoração de Estoque</h1>
    <a href="{{ url_for('exportar_posicao_estoque_csv', **filtros) }}" class="btn btn-secondary">
        <i class="bi bi-download"></i> Exportar CSV
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">Filtros e Ordenação</div>
    <div class="card-body">
        <form method="get">
            <div class="row g-3">
                <div class="col-md-3"><label class="form-label">Data Início</label><input type="date" class="form-control" name="data_inicio" value="{{ filtros.data_inicio }}"></div>
                <div class="col-md-3"><label class="form-label">Data Fim</label><input type="date" class="form-control" name="data_fim" value="{{ filtros.data_fim }}"></div>
                <div class="col-md-3">
                    <label class="form-label">Ordenar por</label>
                    <select name="sort_by" class="form-select">
                        <option value="descricao" {% if filtros.sort_by == 'descricao' %}selected{% endif %}>Descrição</option>
                        <option value="final_valor" {% if filtros.sort_by == 'final_valor' %}selected{% endif %}>Valor Final</option>
                        <option value="final_qtd" {% if filtros.sort_by == 'final_qtd' %}selected{% endif %}>Qtd Final</option>
                    </select>
                </div>
                 <div class="col-md-3">
                    <label class="form-label">Ordem</label>
                    <select name="order" class="form-select">
                        <option value="asc" {% if filtros.order == 'asc' %}selected{% endif %}>Crescente (A-Z)</option>
                        <option value="desc" {% if filtros.order == 'desc' %}selected{% endif %}>Decrescente (Z-A)</option>
                    </select>
                </div>
                <div class="col-md-6"><label class="form-label">Categorias</label><select id="categorias_ids" name="categorias_ids" multiple>{% for c in todas_categorias %}<option value="{{ c.id }}" {% if c.id in filtros.categorias_ids %}selected{% endif %}>{{ c.nome_categoria }}</option>{% endfor %}</select></div>
                <div class="col-md-6"><label class="form-label">Produtos</label><select id="produtos_ids" name="produtos_ids" multiple>{% for p in todos_produtos %}<option value="{{ p.id }}" {% if p.id in filtros.produtos_ids %}selected{% endif %}>{{ p.codigo_sustentare }} - {{ p.descricao }}</option>{% endfor %}</select></div>
                <div class="col-12 text-center mt-3"><button type="submit" class="btn btn-primary">Aplicar Filtros</button><a href="{{ url_for('pagina_posicao_estoque') }}" class="btn btn-outline-secondary">Limpar</a></div>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-hover table-sm text-center">
        <thead class="table-light">
            <tr>
                <th rowspan="2" class="align-middle">Produto</th>
                <th colspan="3">Estoque Inicial</th>
                <th colspan="3">Entradas no Período</th>
                <th colspan="3">Saídas no Período</th>
                <th colspan="3">Estoque Final</th>
            </tr>
            <tr>
                <th>Qtd</th><th>CMP</th><th>Valor</th>
                <th>Qtd</th><th>CMP</th><th>Valor</th>
                <th>Qtd</th><th>CMP</th><th>Valor</th>
                <th>Qtd</th><th>CMP</th><th>Valor</th>
            </tr>
        </thead>
        <tbody>
            {% for item in dados_posicao %}
            <tr>
                <td class="text-start"><small>{{ item.descricao }}<br><span class="text-muted">Cód.S: {{ item.codigo_sustentare }}</span></small></td>
                <td>{{ "%.2f"|format(item.inicial_qtd|float) }}</td>
                <td>{{ "R$ %.2f"|format(item.inicial_cmp|float) }}</td>
                <td>{{ "R$ %.2f"|format(item.inicial_valor|float) }}</td>
                <td class="bg-success-subtle">{{ "%.2f"|format(item.entradas_qtd|float) }}</td>
                <td class="bg-success-subtle">{{ "R$ %.2f"|format(item.entradas_cmp|float) }}</td>
                <td class="bg-success-subtle">{{ "R$ %.2f"|format(item.entradas_valor|float) }}</td>
                <td class="bg-warning-subtle">{{ "%.2f"|format(item.saidas_qtd|float) }}</td>
                <td class="bg-warning-subtle">{{ "R$ %.2f"|format(item.saidas_cmp|float) }}</td>
                <td class="bg-warning-subtle">{{ "R$ %.2f"|format(item.saidas_valor|float) }}</td>
                <td class="fw-bold">{{ "%.2f"|format(item.final_qtd|float) }}</td>
                <td class="fw-bold">{{ "R$ %.2f"|format(item.final_cmp|float) }}</td>
                <td class="fw-bold">{{ "R$ %.2f"|format(item.final_valor|float) }}</td>
            </tr>
            {% else %}
            <tr><td colspan="13" class="text-center p-4">Nenhum dado encontrado para os filtros selecionados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        new TomSelect('#categorias_ids',{plugins: ['remove_button'], placeholder: 'Todas as categorias...'});
        new TomSelect('#produtos_ids',{plugins: ['remove_button'], placeholder: 'Todos os produtos...'});
    });
</script>
{% endblock %}