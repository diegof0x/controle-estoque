{% extends "layout_base.html" %}

{% block title %}Dashboard - Controle Total{% endblock %}

{% block head_extra %}
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Dashboard</h1>
    </div>

    <div class="card mb-4">
        <div class="card-header">Filtros</div>
        <div class="card-body">
            <form action="{{ url_for('pagina_inicial') }}" method="get">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="data_inicio" class="form-label">Período - Início</label>
                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ filtros.data_inicio }}">
                    </div>
                    <div class="col-md-4">
                        <label for="data_fim" class="form-label">Período - Fim</label>
                        <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ filtros.data_fim }}">
                    </div>
                    <div class="col-md-4">
                        <label for="categorias" class="form-label">Categorias</label>
                        <select id="categorias" name="categorias" multiple>
                             {% for categoria in todas_categorias %}
                            <option value="{{ categoria.id }}" {% if categoria.id in filtros.categorias|map('int') %}selected{% endif %}>{{ categoria.nome_categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                    <a href="{{ url_for('pagina_inicial') }}" class="btn btn-secondary">Limpar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-currency-dollar"></i> Valor Total do Estoque</h5>
                    <p class="card-text fs-4">{{ "R$ {:,.2f}".format(kpis.valor_total_estoque|float(0)).replace(',', 'X').replace('.', ',').replace('X', '.') }}</p>
                    <small class="card-text">Na data final do filtro</small>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-danger h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-exclamation-triangle-fill"></i> Itens com Estoque Baixo</h5>
                    <p class="card-text fs-4">{{ kpis.itens_estoque_baixo }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-graph-up-arrow"></i> Itens de Alto Giro</h5>
                    <p class="card-text fs-4">{{ kpis.get('alto_giro_count', 'N/A') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-warning h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-graph-down-arrow"></i> Itens de Baixo Giro</h5>
                    <p class="card-text fs-4">{{ kpis.get('baixo_giro_count', 'N/A') }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <h2 class="h4">Últimas 5 Entradas</h2>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <tbody>
                        {% for mov in kpis.ultimas_entradas %}
                        <tr>
                            <td><span class="badge bg-success">Entrada</span></td>
                            <td>{{ mov.produtos.descricao if mov.produtos else 'N/A' }}</td>
                            <td><strong>{{ mov.quantidade }}</strong> unid.</td>
                            <td class="text-end text-muted"><small>{{ mov.data_local }}</small></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-muted">Nenhuma entrada recente.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-lg-6">
            <h2 class="h4">Últimas 5 Saídas</h2>
             <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <tbody>
                        {% for mov in kpis.ultimas_saidas %}
                        <tr>
                            <td><span class="badge bg-warning text-dark">Saída</span></td>
                            <td>{{ mov.produtos.descricao if mov.produtos else 'N/A' }}</td>
                            <td><strong>{{ mov.quantidade }}</strong> unid.</td>
                            <td class="text-end text-muted"><small>{{ mov.data_local }}</small></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-muted">Nenhuma saída recente.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-6">
            <h2 class="h4">Top 5 Produtos de Alto Giro</h2>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    {% for produto in kpis.get('top_alto_giro', []) %}
                    <tr>
                        <td>{{ produto.get('descricao', 'N/A') }}</td>
                        <td><span class="badge bg-success">{{ "%.0f"|format(produto.get('giro', 0) * 100) }}%</span></td>
                    </tr>
                    {% else %}
                    <tr><td class="text-muted">Sem dados de giro para o período.</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        <div class="col-lg-6">
            <h2 class="h4">Top 5 Produtos de Baixo Giro (Ineficientes)</h2>
             <div class="table-responsive">
                <table class="table table-sm table-striped">
                    {% for produto in kpis.get('top_baixo_giro', []) %}
                    <tr>
                        <td>{{ produto.get('descricao', 'N/A') }}</td>
                        <td><span class="badge bg-warning text-dark">{{ "%.0f"|format(produto.get('giro', 0) * 100) }}%</span></td>
                    </tr>
                    {% else %}
                    <tr><td class="text-muted">Sem dados de giro para o período.</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        new TomSelect('#categorias',{plugins: ['remove_button'], placeholder: 'Todas as categorias'});
    });
</script>
{% endblock %}